#!/usr/bin/env python

import requests
import re
import time
import urllib
from lib.guerrillamail import GuerrillaMailSession

INVITE_TOKEN = "" #5-character reservation ID

while(True):
  session = GuerrillaMailSession()
  email_address = session.get_session_state()['email_address']
  req_url = "https://invites.oneplus.net/index.php?r=share/signup&success_jsonpCallback=success_jsonpCallback&email={0}&koid={1}&_={2}".format(urllib.quote_plus(email_address), INVITE_TOKEN, str(int(time.time())*1000))

  print("Sending invite to " + email_address + "...")
  requests.get(req_url)

  print("Wait for 5 sec...")
  time.sleep(5)

  print("Checking mailbox for the magic email...")
  email_id = None
  for i in range(0, 10):
    email_id = session.get_email_list()[0].guid
    time.sleep(2)
    if session.get_email(email_id).subject != "Confirm your email":
      continue

  print("Found! Fetching email id " + email_id + " body...")
  email_body = session.get_email(email_id).body

  m = re.search('http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\(\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', email_body)
  new_url = m.group(0).rstrip(".")
  print("Clicking confirmation link...")
  requests.get(m.group(0).rstrip("."))
  print("Referral sucessfully spoofed... " + u'\u00af\_(\u30c4)_/\u00af')
  print("")
